\subsection{Framework}

In order to conduct the experiments a framework is needed. This framework should be able to run test cases and measure the energy consumption using the different energy profilers in a round-robin fashion using R3-Validation. In addition to this, different procedures were presented in \cref{subsec:how_to_measure}, which should also be considered when creating the framework.


The first thing to consider, is the energy profilers and test cases, as both of these needs to be implemented in a generic fashion, in order to be able to alter between them during runtime. Because of this, both are implemented using interfaces, as this was concluded not to impact the performance of the system in the work by Sestoft\cite[]{sestoft2013microbenchmarks}. When considering the energy profiler, the implementation can be seen in \cref{lst:energy_profiler}, where the \texttt{IEnergyProfiler} has four methods implemented. The \texttt{Start} and \texttt{Stop} starts and stops the energy profilers measuring respectively, where the input \texttt{date} in \texttt{Start} is used to name the file in which the data is saved. \texttt{GetName} is used to get the name of the current profiler, used for logging and specifying which folder the data should be saved in. Lastly \texttt{ParseCsv} is used to transform the data saved for a given experiment, on a given time in a given folder, into a \texttt{DtoRawData}, this being the format accepted by the database.

\input{listings/i_energy_profiler.tex}

Next up, the implementation for the test case can be seen in \cref*{lst:test_case}, where the \texttt{ITestCase} implements four methods. Here the \texttt{GetLanguage} and \texttt{GetName} returns the language the test case is implemented in, and the name of it respectively. The \texttt{GetProgram} returns the \texttt{DtoTestCase}, which is used to upload the the database, and \texttt{Run} executes the test case one time, and then returns.

\input{listings/i_test_case.tex}

In order to get a better context of how the \texttt{IEnergyProfiler} and \texttt{ITestCase} is used in the framework, some pseudo code representing the outer method handling dependencies and the validity of the result can be seen in \cref*{lst:execute_async}. \texttt{ExecuteAsync} will in line 5 wait until a stable condition is reached, which will be based on the temperature and the battery level, before proceeding. Each time \texttt{ExecuteAsync} is run, it will be done on the same test case, as can be seen in line 8. In line 10-12 it can be observed for how many times the test case will run for, which will be decided based on the temperature and battery level of the system in \texttt{ShouldStopExperiment}, if the last experiment was valid in \texttt{isExperimentValid} and how many times the test case has been run for on each profiler on \texttt{EnoughEntires} to ensure the experiment will not run forever. On each iteration of the \texttt{While}-loop, a new profiler is chosen, as can be seen in line 14, where \texttt{GetNextProfiler} will take the next one, based on which one was used in the last iteration. On the first iteration, the profiler starting, is based on which profiler started last time the experiments were run, which is saved in the database, as covered in \cref{subsec:sql}. In line 18, the experiment is run, and before and after this, different dependencies are initialized or removed. This includes for example a connection to the database, which is not required during the experiments. Lastly, in line 25-26, the results are saved, and the computer is restarted. 

\input{listings/execute_async.tex}

In order to get a better understanding of how the experiments are run, pseudo code for \texttt{RunExperiment} can be seen in \cref{lst:run_experiments}. This method will count how many times the test case executed for and handle measurements of temperatures and battery levels before and after the experiments in line 4, 6 and 23 respectively. In line 7 the wifi/ethernet is disabled before the experiments are conducted, line 8 triggers the garbage collection, in order to ensure all removed dependencies are cleaned up and in line 11 the stopwatch and profiler will be started, in that order. In line 13-17, the \texttt{ITestCase} will execute, until some predefined number of minutes has passed. When the experiment is done, the wifi/ethernet will be enabled again in line 21, and the result will be handled.

\input{listings/run_experiments.tex}



